/*
 * Copyright (c) 2018 Dmytro Shestakov
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */

#include "hal.h"
#include "shell.h"
#include "shell_impl.h"
#include "analogout.h"
#include "digitalout.h"
#include "analogin.h"
#include "chprintf.h"
#include "ch_extended.h"
#include "string_utils.h"
#include <cstdlib>

using namespace std::literals;

static THD_WORKING_AREA(SHELL_WA_SIZE, 512);

static void cmd_setanalog(BaseSequentialStream *chp, int argc, char *argv[]);
static void cmd_getanalog(BaseSequentialStream *chp, int argc, char *argv[]);
static void cmd_setdigital(BaseSequentialStream *chp, int argc, char *argv[]);
static void cmd_getdigital(BaseSequentialStream *chp, int argc, char *argv[]);
static void cmd_svtou(BaseSequentialStream *chp, int argc, char *argv[]);
static void cmd_strtoul(BaseSequentialStream *chp, int argc, char *argv[]);

static const char numbers[] = "452897577\0511071116\0690030679\0119622860\0397863255\0776491188\0431590708\03558"
                              "69041\0968899806\0526841214\0317823550\0818236321\0724097198\0628579230\059195229"
                              "1\0126225365\0240431033\0832862604\0398616473\0733345875\0812652902\0908485671\06"
                              "46503493\0267635648\0222763389\0217526523\0599931869\0678873019\0783556403\0426176764\0457041998\0993851546\0623143972\0701218057\0551745509\0991170790\0736829668\0777774720\0621756093\0048997151\0670520680\0133762118\0711105361\0036605610\0797385238\0478397"
                              "484\0980834360\0173953687\0872215501\0662138713\0266574022\0752636015\0967959945\0048599199\0195932273\0825023330\0138856897\0338519352\0957153676\0003667335\0930160782\0746077943\0318077614\0214061001\0494386343\0386911255\0283718576\0175049514\0544085439\0"
                              "599316820\0963735029\0022725346\0411545005\0696997357\0932146695\0652457441\0314292030\0511930284\0104628160\0713081227\0987817656\0855664281\0328608605\0712736643\0456857487\0587546322\0751209920\0407414840\0886869174\0995202055\0682906309\0708884600\0750681"
                              "547\0215111145\0348031707\0704290169\0001166832\0460754739\0818493050\0426325172\0569386590\0096833975\0259975730\0757041370\0445816289\0378354704\0564410554\0911833804\0510910370\0394837365\0804989959\0419860020\0991831621\0925349090\0757790710\0947494130\0866179086\0999516231\0197"
                              "082730\0756181034\0881872722\0268740041\0429654898\0322324252\0678391822\0186972812\0873240429\0025231979\0536775432\0393521124\0911568656\0886261969\0522933879\0303130598\0022761589\0986028868\0764900044\0068097477\0544980838\0385847295\0192119597\0317750166\0270425639\0684032359\043"
                              "3944561\0992696468\0742521629\0351030202\0056721945\0716124984\0006984374\0921725152\0179911765\0120522159\0085883677\0695175211\0592104516\0240087281\0701309275\0806817168\0125349858\0094657587\0644527222\0397676817\0716757408\0897040094\0694374598\0870621376\0218736953\0752030047\00"
                              "75435417\0618306020\0575740547\0094100148\0940812006\0861051264\0945654194\0626081839\0146561571\0802210149\0573824303\0365422246\0039611491\0539484889\0582883108\0059826755\0584141631\0706357892\0163032072\0683090809\021996"
                              "0971\0603988960\0191460082\0903891945\0008297227\0717051392\0873352306\0347954772\0590892882\0423375493\0102143437\0620113234\0606945649\0207574265\0571754702\0393469380\0106039457\0851876339\0225378"
                              "390\0467012953\0475439592\0731995380\0242900965\0995830995\0086727584\0485951672\0872450539\0184189739\0924514293\0718294146\0223318673\0393504752\0010183226\0294424251\0774642612\0715356627\0132079413\0698369136\0946162607\0820277870\0551488444\0866969699\0094007676\0658063067\013639"
                              "9241\0148352931\0616517247\0012644400\0461080929\0412471247\0828066206\0509697367\0854488523\0445238226\0014664840\0328513499\0935416130\0718675470\0465423277\0735070317\0843653370\0022154980\0974342134\0364606171\0355753374\0695169513\0284264949\0820936254\0224523449\0655636829\08982"
                              "44413\0910248256\0922454665\0437838237\0075679604\0173744307\0255589026\0228443704\0579501076\0161989755\0716294377\0882676903\0460238608\0044119961\0843283972\0257341079\0754867130\0247761608\0850209046\0903047711\098"
                              "1679680\0203458028\0682665687\0871571582\0466717092\0452686654\0359429872\0637391687\0675349330\0105832323\0087538708\0746654033\0348965884\0614237083\0578666451\0047666868\0393700825\0238368433\0469507838\0906969535\0725551433\0922466718\0972724452\0916408430\0542312949\0016225871\05"
                              "78394528\0407336088\0557445071\0558251815\0259476306\0520921667\0897194053\0130601107\0263959446\0736677037\0839206947\0177272630\0932465785\0488782947\0467043837\0089195124\0579643109\0452502540\0626940757\0851722291\0225443980\0639106793\0147820068\0099774047\0236213967\0414217378\08"
                              "54779626\0709116025\0415237009\0722083367\0470644464\0149025568\0841607876\0645107441\0645358439\0702903750\0833627204\0774017754\0586475841\0086624899\0276761902\0440513720\0489337644\0531985464\0762194313\0130160384\02000"
                              "61051\0700561051\0147877826\0662172393\0366382629\0798570261\0599676073\0742510286\0238141644\0741550861\0894999338\0902682117\0966540229\0580265264\0878761952\0040401745\0692598568\0548550230\0924443463\0914102677\0137730107\0315000516\0380753672\0798449168\0056464986\0387732920\031942"
                              "5398\0200027616\0804055515\0139721440\0319810202\0172094753\0035806610\0722163131\0901497921\0049154767\0643329562\0106992899\0985633925\030"
                              "3232581\0302388802\0703688757\0304967448\0934372381\0431108855\0003436809\0696050419\0788845464\0420031083\0917648715\0390324176\0161380918\0444125397\0196568936\0348573098\0161836288\0359797813\0335627";
static const char hexNumbers[] = "0xA381FA0A\00xE14D44E2\00xA4DD46BF\00xEE9F695C\00x952A2ADF\00x6A365F9F\00x70357E45\00x1F94B7D1\00xB5622F90\00x46B70EAE\00x"
                                 "779518F5\00x285BFF6A\00xC466244E\00x5F283D98\00xC516B3FB\00x3D693987\00xB6980DD1\00x0EAF3CD9\00x4EF0AEB4\00xD6E369B9\00x"
                                 "8655810D\00x624EE6C6\00x252E8E12\00xA059CD23\00xC0C95634\00xFD00B913\00x8D2D84B6\00xC9C5B0B4\00xB351058C\00xAB3C1CC1\00x"
                                 "DA3418E8\00xE43F8FCA\00xCA08F04B\00x597BF80C\00x919928F2\00x8CFE89EC\00xA9010D22\00x841819C7\00xBBB61AAF\00xAD85F36B\00x"
                                 "B7B355C6\00xDAD2709C\00x780D42B5\00xBD1BA5AB\00x347ABBF8\00x04134F0F\00xEC5F6B4B\00x814339EA\00xD8BE2B15\00xAE1C7414\00x"
                                 "A53003F6\00x75245F72\00x5F04DBE5\00xA5272E53\00x857430DA\00xAC10A59B\00x1DEF55C0\00x6356565E\00x78D51510\00x1881A824\00x"
                                 "1FA7D4F0\00x39A1EFCA\00xF7DF6C99\00x28FC964D\00x1FC7421D\00xEC0754DB\00xE7B76BDF\00x4C429907\00x10EC4D28\00xDF2AFE36\00x"
                                 "86871A4C\00x58DA1B07\00x6D366684\00x3F6ECA02\00x6BE27FCA\00x9CE98BD6\00xC373B30D\00x87780131\00x26B072ED\00x333B4B50\00x"
                                 "B8EBA683\00x6870D560\00xED4E999B\00xBAA3B95E\00xF4906F66\00xB1306D2B\00x1869B919\00x5D7AEE1B\00x4408FE4B\00x96F4A868\00x"
                                 "6B5D9912\00xA3FBA0EA\00x105854B4\00x4BAC25E1\00x89E132B6\00xF2B45E15\00xC41FABB8\00x3C8A89AE\00xD3A07AED\00x3BAE4FAF\00x"
                                 "11C5BC06\00x4EF0F96E\00xA1515DF1\00x329C2683\00xB7F27E9E\00x896D9A19\00x9F228D6C\00xF4DAC9E7\00xF02F2675\00xFF190D3A\00x"
                                 "773EED8E\00xC0BA194B\00x54A8BCE7\00x140C42F8\00x03B18A06\00xE498AC3D\00x3DE3F6B6\00x167D6F0E\00x99D6EEEA\00xC092362E\00x"
                                 "D3C2CCB3\00x3E499CB0\00xD031B812\00xE4843CA7\00x3F6FA6AB\00x0FE6B1FE\00x455C44DD\00x3443C566\00x3A079EEC\00xDC0D7D31\00x"
                                 "932946F4\00x51FED353\00xDF368501\00xAB318201\00x1CC58AF0\00x61085786\00x152EBBD0\00x9B0569DF\00x137E6848\00x1010F9EA\00x"
                                 "521FF9BB\00x1EF48B59\00x017EFCC8\00x722DF34C\00xD8B58A1D\00xB3EEBE83\00x7A16D62F\00xEB449DE3\00xB38E653A\00x90C72024\00x"
                                 "20449C6E\00xD5FCC141\00xDFCED181\00x80F1A739\00x99FE929D\00xE21EAEA9\00xEB86D268\00xCCAC700B\00xCA254F48\00xF0907ED0\00x"
                                 "C4FD635C\00x8C09FF28\00xB536718A\00xDCC9BB2A\00x17D9113E\00xEE3340DC\00xAA90693E\00x78439CDC\00xDA0D3249\00x1A390C6C\00x"
                                 "D5E4525B\00xD926A1AE\00x33F775B5\00xB2C6CC60\00x0C8E1625\00x7337511D\00xE577AF68\00x3BB5252C\00x2471C14D\00x8EBBC8CC\00x"
                                 "86F4FAC0\00x7EBAB616\00x8B2C3A13\00x104E44F0\00x47440B83\00x51DF56F9\00x7044781F\00xBE5116CC\00x5D84E822\00x873DFD2C\00x"
                                 "B4E806A4\00x5345580F\00x64253BA5\00xCF76F2A2\00x8A6E9EC3\00x11E52925\00xE3C19CF5\00x3213F331\00x50F10C12\00x326BAC1F\00x"
                                 "6B9567D4\00x5AD0EE0F\00x756AA2B3\00xF8E9D10A\00x3149F124\00xAE8A374D\00x4CD1674D\00xB6BD1179\00xE522F803\00x38DF1993\00x"
                                 "E2503B1F\00x783D51C1\00x15CB5443\00x8F548CCB\00x7574B7FC\00x54421EFB\00x966266EF\00x72221A0C\00x6FA8C61D\00xDC2B0C07\00x"
                                 "46CF602B\00xED89A838\00xA1A80DA3\00xC128F94C\00x4E94F499\00x83C42D91\00x97B342F5\00xF30AEE7B\00x34C16B22\00xC00B2B90\00x"
                                 "BAE416AE\00x1EF6AE88\00x7BA25BC8\00xFC9FC430\00xE14025C3\00x2856F04F\00x507FEFD9\00xFF2E7921\00x5CED168C\00xC072CEF5\00x"
                                 "4AA79032\00xA33C763E\00x81075711\00xFDF9BA51\00x43BE2CFA\00x70B69F0F\00x37E1591D\00xE64EB40C\00xB78260BF\00x35B6DF7E\00x"
                                 "9DC8BCD5\00x294ED45B\00xDFC9C8C2\00xD018FBC7\00x9D36A0A2\00xBFD2309F\00xD2D17D90\00x0BF62B5B\00x5703C848\00xB3383FC6\00x"
                                 "E2FFC1C8\00xDC93B835\00xB498C5CC\00xDAAC2485\00x909DDD62\00xBDFBF468\00xA321B1C7\00x9F5BBF84\00x05F20AC7\00x1F835E16\00x"
                                 "222DA90E\00x3675C0DF\00x7E4658E1\00xAEABB44B\00x60DE48E5\00xAEFFB2D1\00xB5DB2CED\00xDDA8E334\00x880C5554\00xC120690C\00x"
                                 "92A1FA26\00xE640913E\00x0C7DC817\00xE52D3418\00x3C8A4AFA\00x734B9FEA\00x45B65C26\00x345FAB89\00x28ABC741\00xD1908BFA\00x"
                                 "D37D0076\00x62B6D8DD\00x877B4C54\00x4011EB76\00x65A16C25\00x1670A71C\00x71E9276F\00x1D59491B\00x19100B2F\00x68287160\00x"
                                 "70F8C1D8\00x3A528D28\00xCD8D1E22\00x5BF65A50\00xCBE43671\00x1683C6CD\00x5F784D1A\00xEB5B75FA\00xFF2C3A04\00xF293CB3A\00x"
                                 "BEFD7281\00xF9EA9ABD\00xC2130688\00x1384004E\00x887B8FC5\00x514C71F3\00x3D83E455\00x0A6D22AB\00x82B12196\00x3335ADAA\00x"
                                 "9DA755E7\00x410B22EA\00xCAC366B1\00x01212983\00xD7AE12D4\00x2061C0B5\00x0BAC6752\00xEBCFA998\00xD4141867\00xABE7AF9D\00x"
                                 "457940D7\00x4CEFC639\00x59F94097\00xE2977856\00x6346D155\00x4A7850FF\00x857FDF14\00xDA9106A4\00x9BE0D2B8\00x942338ED\00x"
                                 "08F48E32\00x0A66D051\00x7C39B75E\00xDA5F25BC\00x50800E84\00x1BE97D72\00x98FD02EA\00x6C0922F8\00xE9491D6E\00x69062F2B\00x"
                                 "17032A8C\00xCEABB79C\00x195E0EAB\00x53E68DE9\00x39406566\00x7E8782B3\00xF1FE33A7\00xFC9EBD2D\00xBB3DFFF7\00x332A7D73\00x"
                                 "3C5A9147\00x11DC6409\00xD41985E0\00xE2F7A786\00x1217981B\00x505A4F61\00xD24A5D68\00x348F84FB\00x4FC7614F\00x1C20D6A3\00x"
                                 "B3BDC9A9\00x01991C55\00x5AF80E84\00x3CB1D4F3\00x7715F6EA\00x6C0F8D20\00xC5D9E435\00xA57F51CE\00x20FC148F\00x3B2298A0\00x"
                                 "697D01D8\00x2EF0ECAA\00xFC0C514F\00xDB4C55BD\00x4C97C737\00x1C498FCB\00xBD27703E\00x5B01CD93\00x7A0BDAA2\00xF46CDB2E\00x"
                                 "6ED75E22\00x63705C68\00x7ADD7667\00x4C76B50C\00xF098041E\00xD98D26A2\00x1CDE82F3\00x2AB4E34A\00x3700AFEE\00x860670B4\00x"
                                 "007FED19\00x05095E0D\00xEEA5CD94\00xDBBA7448\00x395DA50A\00x1EB8C53B\00xC8980081\00xBE03BB4A\00x9265B17A\00x607DD975\00x"
                                 "0E91B003\00xF01A7A50\00xEE5725EF\00x77BE163B\00xC1A9ABEE\00xFCD7EFF4\00x9A553353\00x50749F54\00x61B0F6B8\00x89742F5B\00x"
                                 "DB0DC555\00xE5DD0239\00x28704628\00xDF57840D\00xF458B1F6\00x49319D75\00x9B2344B3\00x09DA9D1F\00xC50B3A33\00x987BACCA\00x"
                                 "F9C58C8A\00x3E15E9DB\00x8BB150C4\00xE8BF35E0\00x3E098A69\00x2C322FBE\00xF9D3493F\00xA135944C\00x10BF00F5\00x6A1A8634\00x"
                                 "DF516330\00xF747F3C0\00x867DCA32\00x8CE90916\00xADC0418C\00x01790F70\00x83938AE8\00xEE41F301\00xAF820A75\00x1C01F76B\00x"
                                 "6105132B\00x9D4AC18F\00xC36A3EED\00x0B4C6259\00x218E04CC\00xC0A12C98\00x9F4E1293\00xE63B0E0D\00x9995E87F\00x1FD48B98\00x"
                                 "0D4814F0\00xF9602F5D\00x386F1A3D\00x75E6A9FA\00x4819DD65\00x58B821CB\00x4816B12A\00x31697A33\00xB70B6B1E\00x4B8467A9\00x"
                                 "2D5B5455\00xF8FF9D47\00x168DF490\00x12F69C3C\00x1BD0F300\00xB830C57E\00xE5E310B6\00xEE6B4AEB\00x9763D258\00xCAD411AF\00x"
                                 "BEDA9AB9\00xDB505C41\00x135DAFF4\00x979327E5\00x2BBC07A4\00x46A98585\00x1FDA79E6\00xE4D91B56\00xEE237083\00x366E08B2\00x"
                                 "3D85F473\00xDAAF5D45\00xF0CC4ACF\00x8E8E11D4\00x3F4F290C\00x3C4837FB\00xF55BA6F0\00x754B6CB9\00x139AF720\00x63B0EC65\00x"
                                 "CD32C516\00xAC5AC183\00x4A85B8B2\00x807F9BED\00x0E8FB008\00x05CB4077\00x98980720\00xA19C7FD6\00x08FA5C17\00x0106AFFE\00x"
                                 "1A68AB03\00x73E219D1\00xD1C979A0\00xCD5CC184\00x530F6CDB\00xA7B6D3B4\00x80FA45EC\00x5E771612\00xF57DAC57\00x07F959AE\00x"
                                 "07A40ACD\00x74D73CC1\00x095A101B\00xB22A7D61\00x2489EFEF\00x00B10FCA\00x33BB1DDC\00x4D49E5FE\00x2F1609D2\00xF1D2A238\00x"
                                 "737C9ECC\00x069DC74C\00xD9BD5001\00x8BBC724F\00x233D214C\00x192297BA\00x890EED94\00x8917E587\00xC329EC40\00xA1683731\00x"
                                 "8275F3D6\00x34C1BC74\00xBE6B4723\00x4AFA6AEC\00xFAE38BC4\00x64B73DAD\00x92C6C3E6\00x1B9E0B71\00xC30B9438\00x88C00AF3\00x"
                                 "5ABEC648\00x5F9209DE\00xA268F605\00xF9596755\00xBF602DAE\00x2DA92617\00x1470418C\00x9D9A5E4B\00x9DECD85D\00xD4B443B3\00x"
                                 "A1BC8E6B\00x7B9CA181\00x9B05E2AF\00xD4B75E23\00x7B16726F\00xE2F6643C\00xD9FCA131\00x2EC42980\00xA33A808B\00x0FA96358\00x"
                                 "D366D13D\00x76A174FA\00x4E64FAAB\00x755B30C2\00xFE7B6E8E\00x87A677FE\00x2D656816\00xC41B6735\00xB8B69070\00xD5C48FF4\00x"
                                 "C7E3BA3F\00xFC6B6F15\00x9FCC9935\00xABAA609D\00x1839A059\00x3A26D675\00xB2DCF15D\00xBD4A35D5\00xC46CFB6A\00xF8F15FA4\00x"
                                 "457DD828\00xB179A92B\00xFB175BD5\00xC7C823A6\00xDEACADBA\00xF3A582F3\00xE21AFBFC\00x0B755FF3\00x968E9C1B\00xF8FD42A6\00x"
                                 "BB3D233A\00xF8B37134\00x2C368E25\00xCBF5F150\00xAF92FB2D\00xCA911248\00xD4264187\00x3F53C567\00x1EEF1B63\00xBB970A38\00x"
                                 "9B5476F3\00x161F9B45\00xD73F9EDE\00x2DBB9186\00x606A8211\00x44C7EF85\00x217DB8D8\00xD786D479\00xE8B11C16\00x235900AD\00x"
                                 "BDF5376B\00x059426CC\00x6A1E8714\00xA98AB4B5\00x2ADE2292\00xF6FB3C19\00x817F6C97\00xFDFE8802\00xDBBCDE48\00x81F3EED2\00x"
                                 "530B5A78\00xD85D65FC\00xE3570A87\00xC32DB889\00x82C059E5\00x42BC123E\00x9FCE902E\00xFDC4DD66\00x04183E7C\00x2BD816CB\00x"
                                 "705EEDAB\00x8927C1C9\00x3416B1CD\00x9B33AEF9\00x10DA1843\00xA5C2B288\00x2D666755\00x37211C9F\00x70B04C94\00x44BF29BE\00x"
                                 "D3859B19\00x7E4660A0\00x0A29A6E5\00xE3D3FE0B\00x848B9D58\00x2A66DCAF\00x49B33F65\00x19FA59E6\00xFAF40D51\00xC407045E\00x"
                                 "E74C7FA8\00x7C6D7B4F\00x02365FD1\00x2BEAFD2C\00x70C4C2A5\00x0E4E0AAD\00x3EEBDDF7\00x965036F9\00x34A48119\00x2451C6C9\00x"
                                 "B0FCBD6E\00xE8730334\00xC449DA7C\00x007225DB\00xDFF359FF\00x8B7B4AE2\00xE4C1D624\00x5CDE2E0B\00x81B6A473\00x281C1BBE\00x"
                                 "74080A35\00x8DA75754\00x1164C5FA\00xF7CDCFAA\00x063776BC\00x26F6D23E\00xD72581FC\00x867C4EF5\00x983733B8\00xAECAE7D7\00x"
                                 "171E6E71\00x1A262113\00x0B9BF099\00xE460BEEB\00x1885274A\00xCAB5E21F\00xF18F5C64\00x0E997F13\00x38A96B2C\00x8EA4BBA4\00x"
                                 "12534773\00xED11D3C4\00xAB67ECDA\00x123BCDA6\00x85FAF31B\00xCA2EBF1A\00xEB5CBE39\00x1E03D726\00xA271E7BE\00x74C057EB\00x"
                                 "B589E288\00xF38D0E3F\00x4346FD7C\00x68A6E3B2\00x55DC7FE6\00xFF474CD0\00x2004ED13\00xD3C834BF\00xE443C206\00x0B3B2C78\00x"
                                 "28B434C8\00x70A626A9\00x727E3778\00x32D3A9AC\00x8F81E3F3\00x4A546E48\00x2E099082\00x506BCCF8\00x58CAE90B\00x6919E88E\00x"
                                 "D560BC96\00xBDB63BE7\00x5701C01E\00x80CC64E1\00x3CC2EE4A\00x7E3FDD1A\00xAF5CCCC7\00x519B3B44\00xEBB130A8\00xA15186C1\00x"
                                 "25048F2D\00xC075AFF0\00x7398F964\00xDF2176C6\00x4D8D8410\00xE11B99C1\00x2141CFD0\00x9DF3E353\00xCECD8E45\00x478143B7\00x"
                                 "A460B77B\00x0EDDBBC2\00x56C6C582\00x65A52A4E\00x3869303E\00x57CE502A\00x6D77F128\00xCFDA9CFC\00x765D9652\00xB6C536BA\00x"
                                 "52A68F6E\00xA26F9C94\00x67AD3891\00xB45ED036\00x447ACFDA\00x8C58D810\00x4CE4659C\00x18174457\00xA2378968\00x023700A7\00x"
                                 "65E3BD35\00x758EEC69\00x9894683D\00x8EA91DC8\00xC41D9762\00xE6FF5E01\00x8ADC96D6\00x72FB4A8B\00xADC68957\00x9312BBD5\00x"
                                 "4AE3C26F\00x12B21C30\00xA526887B\00x17C25B1D\00xE6466EBA\00xD4C78A5E\00x3E803002\00x9CA4D9F6\00x75366BCF\00xB1DC5CE7\00x"
                                 "D6AF0C1A\00xF5CEBC80\00xA4AAAA38\00x3C47765B\00x99D748E9\00x7A1DCFEE\00x3D603565\00xE23D4E8D\00xA909ADC5\00x09727096\00x"
                                 "EE62CC85\00xD96B4D76\00x26DBE3F1\00x44E72B67\00x996D079E\00xE715DAB4\00x7130AF64\00x58F5F160\00x2DCC56B5\00xECA60BC2\00x"
                                 "FE05CDFA\00x6DA9DF5A\00xBEDF536A\00x386E6D62\00x98E5633E\00x7C0B234B\00xCEFCDC30\00x9F2EFBD4\00xCE8C8008\00xB17D9210\00x"
                                 "5B4DA498\00xEA770887\00xB7F62D13\00x32CE83D7\00xC637AA1F\00x5A5183CB\00x325B32B8\00x8D63BD54\00x6BFCA001\00x1CD0ED3C\00x"
                                 "097B8758\00x161D0743\00x33DC2249\00x3FBC013D\00xB6C78CE8\00xB009F296\00x042F2A51\00x8DD95B06\00x330C9803\00xB1DA6875\00x"
                                 "FA8F8E73\00x8099B6E4\00xE2522129\00x9C5FA1CA\00x62925B17\00xF44875BF\00xE3DD7EAD\00xE7C633E0\00xCA40F0A1\00x1910E746\00x"
                                 "34E35997\00x73687AEC\00x3502825E\00x5E803A9D\00x4BFAF642\00x62DB9FFC\00xB4C81F2F\00x77278726\00xC83B42DF\00xD7A2396D\00x"
                                 "5B3AFE32\00x340CF16F\00x0D411845\00x1EA1159E\00xA99234AB\00xEF112CBB\00xDE7680F8\00xB9BA70AA\00xEEA3FE75\00x3490B8A1\00x"
                                 "7DFC9392\00x9BCC33BB\00xDD79287B\00xAE635E07\00x8489F169\00x2528AC38\00xCFE9256A\00x442995FF\00xB064D6BC\00x3D61D60F\00x"
                                 "54942FBC\00x85F739EE\00xBDE78C4F\00xBA12EBCE\00x6E8CFCF5\00x8BEEE5B9\00x02584AE3\00xC07C4854\00xB5B824F7\00xA7F3FFC8\00x"
                                 "E6C89BDA\00x9AF97C44\00x66ADD2FD\00xE1C38AC8\00x21140A47\00x621DE9ED\00x1480E0F1\00xA3C66DE5\00xDE438EE3\00xA8D99900\00x"
                                 "0B61C74B\00x51399D3F\00x06AEBA96\00xBC53F025\00x7714EA4C\00xD919C35C\00x8FE6F7FE\00x4535994F\00x8B6D23CB\00x4DF95657\00x"
                                 "75378528\00x630A5BEC\00x3A0EC010\00x49611DC9\00x0A466DD5\00x345D6435\00x89E1B3F2\00x8FE5FD1C\00xF1C53980\00xE7317E42\00x"
                                 "370B050D\00x3904E3AE\00x0E0AF4B2\00x79013742\00x843868D4\00x77B6930C\00x6BB95541\00x10B60011\00x04E3FFC0\00x79CDDD87\00x"
                                 "8B091AF0\00x67F660AD\00x4F7B680A\00xFE863BF6\00x904C9F0D\00xB691C224\00x0FA31D69\00x187FEED4\00x2FF93A38\00xCA5D14ED\00x"
                                 "224D7C90\00x03725A94\00x2242017D\00xAC84DF77\00x57FBC766\00x9BAD87AA\00x4A6048E8\00x200A2A3D\00x1F548974\00x7F7ED860\00x"
                                 "3F58BB64\00x548354F4\00x15ED2E55\00x31809056\00x60E95124\00x24E805EB\00x2DD0E245\00x1C1F9575\00xEDBED23C\00xCFEF4167\00x"
                                 "B225E2F6\00xF4FC5612\00x321B8741\00x94431E78\00xB09AD113\00x084E9465\00xA09760BA\00xA2AF91E8\00xB3876025\00x0316D1CF\00x"
                                 "B2F21B6A\00xC32ED40C\00xB2395B69\00x77A4C444\00xAD75BAF4\00x6D61235F\00xCDD3286C\00xDF389A9A\00x1B67ADA8\00xED332304\00x"
                                 "A2C20B3F\00x54AC3240\00xE0CE4D02\00x4C6706CC\00x2440A64E\00xEC6674FB\00x7EF6FDCE\00xA6B393F7\00x81CA03D7\00xA57A01E0\00x"
                                 "CDD43CEB\00x653A94C8\00xB26A8094\00xB144BA1B\00xC60EA124\00xB00AE0B0\00x1CF394EC\00x04F74DCA\00x4B7BF5B7\00xDFF84793\00x"
                                 "B8913CB8\00x2FD2DA25\00xA3B1E324\00xFEED4E49\00x4CCB3821\00x25D26AE1\00x92881DA4\00xE0A94D04\00xB8546BFF\00x8094B64D\00x"
                                 "044F713A\00x3D297766\00xE31F1045\00xCCB57B70\00xAD535077\00xEB2364FC\00x17FAE015\00x7FCCB9FE\00xCE1E2348\00x41459161\00x"
                                 "6A993AA2\00x5CBA7D65\00x6B61F3F2\00x77186C1D\00x192BD0BD\00x821A1573\00x56D8B4C7\00x1A904F5F\00xCE39D22D\00x639C061C\00x"
                                 "47A0F283\00x9177CFDB\00x33739898\00x7838AE76\00x84EF5300\00x6DAF50C2\00x748BB2FA\00xC60A9B57\00xDF0B66CD\00xFEBCF971\00x"
                                 "F3207505\00xB2AF6006\00xBE6284D0\00x3D9163AC\00x100401A5\00xDA595BB5\00xCD7D55E5\00x8A6B0E5C\00xC0D82330\00x59069E1C\00x"
                                 "5D7B7366\00x1C110028\00x1EACD0EA\00xD8B4AB45\00x8327989A\00x4DF226D4\00xD383164A\00xA5AEC561\00x7E1C19EE\00x98C74704\00x"
                                 "CAEC312A\00xABDC9FAB\00xDC6B2295\00xF9741D3F\00x221B7EE7\00x0788FBDF\00xFE0854FD\00x872B17A6\00x6DA8AE53\00x955CC467\00x"
                                 "2F595664\00x2CD91775\00xEC4FEC24\00x0741457F\00x27958586\00x6508A818\00x269C4BEF\00xAFC69485\00x4B304508\00xE9BB295A\00x"
                                 "3601EC81\00x7E503288\00xBEE1104E\00x0D18F047\00xEBCDC817\00x122C1929\00x98F8EF72\00x976AB0D1\00xEA62EA14\00x85F42E3A\00x"
                                 "AD0CFCA4\00xB703C418\00x8C208570\00xF894618B\00xAE18D92A\00x765CB045\00x59BCE516\00x28976B03\00x1BD01C8A\00xC256FD5F\00x"
                                 "2C734117\00x248417AF\00x5250AB59\00x2B911952\00xB8FF93C4\00x5A1D36F6\00x1BE299FC\00x5499DC9D\00x97FE72EE\00x9CBAA556\00x"
                                 "174E521F\00x9EC0D362\00xEE07C1C3\00x7E356DA0\00x326832DA\00xAC6F6A5B\00xFFB94E76\00xF5851282\00x1488AC0A\00xA4CD83E9\00x"
                                 "5E537C83\00x353B9BE4\00xB9B78D5E\00xE5A227F2\00xDAF9C6BB\00xE72EE87C\00xEDEFDC28\00x1375ACB0\00xEA456D18\00x5EFD9CF1\00x"
                                 "A85DB769\00xF3A3F6CB\00x847F18F6\00x9CF857C3\00x0DBB385B\00x7D909B60\00x776A83A3\00xCC270024\00x3B70F1C6\00xBA6DC15C\00x"
                                 "4A2DD0D9\00xABEBEB11\00x0F96B21C\00x33B86757\00xC67BAB2E\00xB49A6E4C\00x8EC972C3\00x4DD43BE4\00xC91B3063\00x716D18AA\00x"
                                 "7CF38B6D\00x0D0F265E\00x555C7DFD\00x8CC4AFDD\00xF3D4363F\00x777D8B59\00x8C2EA886\00x82E283AC\00xA8285609\00xC2F199DF\00x"
                                 "949EE430\00x90E16C68\00x12728ED3\00x333C0E64\00x52D19FC4\00x4AFC4645\00x6C112C48\00x2EB1D877\00x645398E9\00xD6A6A1B5\00x"
                                 "75514172\00x65E14A05\00x07CA729E\00xF33593DF\00xFD839211\00x6757B98E\00xFE9E1020\00x08FB5343\00x14A87713\00x785D0702\00x"
                                 "84543123\00xA28ADAAC\00x64D8A567\00xC8416B48\00xFCDF4BCE\00xAD03027B\00xF93DD843\00x1E12FD68\00xE186983F\00x0A740024\00x"
                                 "88988967\00x1A03D640\00x416FE5A4\00xC8A39248\00xB84989F0\00xAB1451BF\00xB641BF99\00xE82DE07E\00x73DA237F\00xA6FD8CCF\00x"
                                 "760A092F\00x3E457270\00x59F690E0\00xE9E12223\00xCDD871C0\00x46A5BB58\00xFB9B64B9\00x1216AFC5\00xCAACD636\00x426037F4\00x"
                                 "6800CB72\00xECE27AFC\00x498A52B2\00xB774659A\00xE7F8C051\00xC8A065B5\00x86983A47\00x857C1D1B\00xF1FC5CD4\00xCD58EF2B\00x"
                                 "C60B9A82\00x40AD8AC5\00xD376EEB1\00x2C8E9C1A\00x63407514\00xF2C985EE\00x3D27D214\00x0B317E27\00x0D741374\00x88145EA0\00x"
                                 "C376D4F8\00xAE285D4A\00xD8F4A43B\00xB9DD4DC7\00x4D2D2F99\00x4F3EE5C9\00x730C32BD\00x498C1DA5\00x43A9B4FA\00x4F3A35A1\00x"
                                 "1CCB5AE7\00x41E0C41D\00x62476A60\00x11482536\00x18207C4D\00x97E48FB8\00x12155F77\00x6BE3E67E\00x56251B3F\00x75C2A453\00x"
                                 "1B11E9C3\00x36C50444\00x2822AD29\00xE7539940\00x99A1C052\00x683DB17C\00x73F49816\00x631F1E26\00xDC230CFE\00xDD8BAC83\00x"
                                 "EFBD4DCE\00xDB7CC959\00x393831F0\00x90304587\00xA84AA105\00x26A1F2E9\00xFE93ACE4\00xDC7A5253\00x093290E6\00xE9F5845C\00x"
                                 "11967290\00x089C0244\00x62DFD52F\00xDF4B1451\00x787DB6EE\00x4CDA832E\00xBAE52BB1\00xDAC4F786\00xAF8E5CC5\00x598E1F8D";
static const ShellCommand commands[] = {
  {"setanalog", cmd_setanalog},
  {"getanalog", cmd_getanalog},
  {"setdigital", cmd_setdigital},
  {"getdigital", cmd_getdigital},
  {"svtou", cmd_svtou},
  {"strtoul", cmd_strtoul},
  {nullptr, nullptr}
};

void cmd_svtou(BaseSequentialStream *chp, int /*argc*/, char **/*argv[]*/)
{
  auto now = Rtos::System::getTime();
  for(size_t a = 0; a < 100; ++a) {
    for(size_t i = 0; i < sizeof(hexNumbers); i += 44) {
      io::svtou(std::string_view{&hexNumbers[i], 10});
      io::svtou(std::string_view{&hexNumbers[i + 11], 10});
      io::svtou(std::string_view{&hexNumbers[i + 22], 10});
      io::svtou(std::string_view{&hexNumbers[i + 33], 10});
      io::svtou("0XFFFFFFFF");
      io::svtou("0XFFFFFFFFF");
      io::svtou("0x0000CCCC");
      io::svtou("999999999");
      io::svtou("5999999999");
      io::svtou("4299999999");
    }
  }
  auto ticks = Rtos::System::getTime() - now;
  chprintf(chp, "Execution time: %u\r\n", ticks);
}

void cmd_strtoul(BaseSequentialStream *chp, int /*argc*/, char **/*argv[]*/)
{
  auto now = Rtos::System::getTime();
  for(size_t a = 0; a < 100; ++a) {
    for(size_t i = 0; i < sizeof(hexNumbers); i += 44) {
      strtoul(std::string_view{&hexNumbers[i], 10}.data(), nullptr, 0);
      strtoul(std::string_view{&hexNumbers[i + 11], 10}.data(), nullptr, 0);
      strtoul(std::string_view{&hexNumbers[i + 22], 10}.data(), nullptr, 0);
      strtoul(std::string_view{&hexNumbers[i + 33], 10}.data(), nullptr, 0);
      strtoul(std::string_view{"0XFFFFFFFF"}.data(), nullptr, 0);
      strtoul(std::string_view{"0XFFFFFFFFF"}.data(), nullptr, 0);
      strtoul(std::string_view{"0x0000CCCC"}.data(), nullptr, 0);
      strtoul(std::string_view{"999999999"}.data(), nullptr, 0);
      strtoul(std::string_view{"5999999999"}.data(), nullptr, 0);
      strtoul(std::string_view{"4299999999"}.data(), nullptr, 0);
    }
  }
  auto ticks = Rtos::System::getTime() - now;
  chprintf(chp, "Execution time: %u\r\n", ticks);
}


static char histbuf[128];

static const ShellConfig shell_cfg1 = {
  (BaseSequentialStream *)&SD1,
  commands,
  histbuf,
  128
};

void cmd_setanalog(BaseSequentialStream *chp, int argc, char *argv[])
{
  using namespace Analog;
  OutputCommand cmd{};
  auto PrintValues = [&] {
    chprintf(chp, "%4u %4u %4u %4u\r\n",
             cmd.GetValue(0),
             cmd.GetValue(1),
             cmd.GetValue(2),
             cmd.GetValue(3));
  };
  if(argc == 0) {
    output.SendMessage(cmd);
    PrintValues();
    return;
  }
  if(argc == 2) do {
    pwmchannel_t ch = *argv[0] - '0';
    if(ch > 3) {
      break;
    }
    int value = atoi(argv[1]);
    if(value < 0 || value > 4096) {
      break;
    }
    cmd.SetValue(ch, (uint16_t)value);
    output.SendMessage(cmd);
    PrintValues();
    return;
  } while(false);
  shellUsage(chp, "Set analog output value on selected channel"
                  "\r\nReturns array of current values"
                  "\r\n\tsetanalog [channel(0-3)] [value(0-4096)]"
                  "\r\nExample:"
                  "\r\n\tsetanalog 1 2048");
}

void cmd_getanalog(BaseSequentialStream *chp, int /*argc*/, char **/*argv[]*/)
{
  using namespace Analog;
  auto samples = Analog::input.GetSamples();
  for(auto sample : samples) {
    chprintf(chp, "%4u ", sample);
  }
  chprintf(chp, "\r\n");
}

void cmd_getdigital(BaseSequentialStream *chp, int /*argc*/, char **/*argv[]*/)
{
  using namespace Analog;
  chprintf(chp, "%x\r\n", input.GetBinaryVal());
  for(size_t i{}; i < 10; ++i) {
    auto counters = Analog::input.GetCounters();
    for(auto counter : counters) {
      chprintf(chp, "%8u ", counter);
    }
    chprintf(chp, "\r\n");
    chThdSleep(MS2ST(1000));
  }
}


void cmd_setdigital(BaseSequentialStream *chp, int argc, char *argv[])
{
  using namespace Digital;
  using Mode = OutputCommand::Mode;
  OutputCommand cmd{};
  do {
    if(argc == 0) {
      output.SendMessage(cmd);
      chprintf(chp, "%x\r\n", cmd.GetValue());
      return;
    }
    else if(argc == 3 && "set_clear"sv == argv[0]) {
      //FIXME: not thread safe
      errno = 0;
      int32_t setVal = (int32_t)strtoul(argv[1], nullptr, 0);
      if(errno || setVal < 0 || setVal > 65535) {
        break;
      }
      int32_t clearVal = (int32_t)strtoul(argv[2], nullptr, 0);
      if(errno || clearVal < 0 || clearVal > 65535) {
        break;
      }
      uint32_t val = (uint32_t)setVal | uint32_t(clearVal << OutputCommand::GetBusWidth());
      cmd.Set(Mode::SetAndClear, val);
      output.SendMessage(cmd);
      chprintf(chp, "%x\r\n", cmd.GetValue());
      return;
    }
    else if(argc == 2) {
      if("set"sv == argv[0]) {
        cmd.SetMode(Mode::Set);
      }
      else if("clear"sv == argv[0]) {
        cmd.SetMode(Mode::Clear);
      }
      else if("write"sv == argv[0]) {
        cmd.SetMode(Mode::Write);
      }
      else if("toggle"sv == argv[0]) {
        cmd.SetMode(Mode::Toggle);
      }
      else {
        break;
      }
      //FIXME: not thread safe
      errno = 0;
      int32_t value = (int32_t)strtoul(argv[1], nullptr, 0);
      if(errno || value < 0 || value > 65535) {
        break;
      }
      cmd.SetValue((uint16_t)value);
      output.SendMessage(cmd);
      chprintf(chp, "%x\r\n", cmd.GetValue());
      return;
    }
  } while(false);
  shellUsage(chp, "Set state of the digital output register"
                  "\r\npossible modes: set, clear, set_clear, write, toggle"
                  "\r\nReturns modified register value"
                  "\r\n\tsetdigital [mode] [mask(0-65535)]"
                  "\r\nExamples:"
                  "\r\n\tsetdigital set 0x2020"
                  "\r\n\tsetdigital set_clear 0x0088 0xFF00"
                  "\r\n\tsetdigital toggle 666");
}


Shell::Shell()
{
  palSetPadMode(GPIOB, 6, PAL_MODE_STM32_ALTERNATE_PUSHPULL); // tx
  palSetPadMode(GPIOB, 7, PAL_MODE_INPUT); //rx
  SerialConfig sercfg{ 115200,
                       USART_CR1_TE | USART_CR1_RE | USART_CR1_UE,
                           0,
                           0};
  sdStart(&SD1, &sercfg);
  shellInit();
  chThdCreateStatic(SHELL_WA_SIZE, sizeof(SHELL_WA_SIZE), NORMALPRIO, shellThread, (void*)&shell_cfg1);
}
